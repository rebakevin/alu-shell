#!/usr/bin/env bash
# Init script to manage the manage_my_process daemon

# Ensure manage_my_process is executable
if [[ ! -x "./manage_my_process" ]]; then
    echo "Error: manage_my_process is not executable or not found"
    exit 1
fi

case $1 in
    start)
        if [[ -f /var/run/my_process.pid ]] && kill -0 "$(cat /var/run/my_process.pid)" 2>/dev/null; then
            echo "manage_my_process is already running"
            exit 1
        fi
        ./manage_my_process &
        pid=$!
        if kill -0 $pid 2>/dev/null; then
            echo $pid > /var/run/my_process.pid
            echo "manage_my_process started"
        else
            echo "Failed to start manage_my_process"
            exit 1
        fi
        ;;
    stop)
        if [[ -f /var/run/my_process.pid ]]; then
            pid=$(cat /var/run/my_process.pid)
            if kill -0 $pid 2>/dev/null; then
                kill $pid
                wait $pid 2>/dev/null
            fi
            rm -f /var/run/my_process.pid
            echo "manage_my_process stopped"
        else
            echo "manage_my_process is not running or PID file missing"
            exit 1
        fi
        ;;
    restart)
        if [[ -f /var/run/my_process.pid ]]; then
            pid=$(cat /var/run/my_process.pid)
            if kill -0 $pid 2>/dev/null; then
                kill $pid
                wait $pid 2>/dev/null
            fi
            rm -f /var/run/my_process.pid
        fi
        ./manage_my_process &
        pid=$!
        if kill -0 $pid 2>/dev/null; then
            echo $pid > /var/run/my_process.pid
            echo "manage_my_process restarted"
        else
            echo "Failed to restart manage_my_process"
            exit 1
        fi
        ;;
    *)
        echo "Usage: manage_my_process {start|stop|restart}"
        exit 1
        ;;
esac
